<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Layout of state variables in storage, memory &mdash; Tuhalang</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/vendor/share.js/dist/css/share.min.css"><link rel="canonical" href="https://tuhalang.github.io/2022/03/28/Layout-Of-State-Variables-In-Storage/"><link rel="alternate" type="application/atom+xml" title="Tuhalang" href="https://tuhalang.github.io/feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/favicon.ico"><meta property="og:title" content="Layout of state variables in storage, memory"><meta name="keywords" content="Smartcontract, Blockchain, Solidity"><meta name="og:keywords" content="Smartcontract, Blockchain, Solidity"><meta name="description" content="How to the storage or memory save state variables of the contract? In this post, we will discover it together."><meta name="og:description" content="How to the storage or memory save state variables of the contract? In this post, we will discover it together."><meta property="og:url" content="https://tuhalang.github.io/2022/03/28/Layout-Of-State-Variables-In-Storage/"><meta property="og:site_name" content="Tuhalang"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2022-03-28"> <script src="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/js/main.js"></script> <script data-ad-client="ca-pub-7093222719567591" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-161740789-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-161740789-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://tuhalang.github.io/" title="Tuhalang"><span class="octicon octicon-mark-github"></span> Tuhalang</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://tuhalang.github.io/" class=" site-header-nav-item" target="" title="Home">Home</a> <a href="https://tuhalang.github.io/categories/" class=" site-header-nav-item" target="" title="Categories">Categories</a> <a href="https://tuhalang.github.io/archives/" class=" site-header-nav-item" target="" title="Archives">Archives</a> <a href="https://tuhalang.github.io/wiki/" class=" site-header-nav-item" target="" title="Wiki">Wiki</a> <a href="https://tuhalang.github.io/about/" class=" site-header-nav-item" target="" title="About">About</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Layout of state"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Layout of state variables in storage, memory</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2022/03/28 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://tuhalang.github.io/categories/#Smartcontract" title="Smartcontract">Smartcontract</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://tuhalang.github.io/categories/#Blockchain" title="Blockchain">Blockchain</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://tuhalang.github.io/categories/#Solidity" title="Solidity">Solidity</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> Common 2827 words，about 9 minutes </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>How to the storage or memory save state variables of the contract? In this post, we will discover it together.</p><h3 id="1-layout-of-state-variables-in-storage">1. Layout of state variables in storage</h3><ul><li>Firstly, each storage slot stores 32 bytes data. Except for dynamically-size arrays and mappings, data is stored contiguously item after item starting with the first state variable, which is stored in slot <strong>0</strong>.</li><li>Multiple, contiguous items that need less than 32 bytes are packed into a single storage slot if possible, according to the following rules:<ul><li>The first item in a storage slot is stored lower-order aligned.</li><li>Value types use only as many bytes as are necessary to store them.</li><li>If a value type does not fit the remaining part of a storage slot, it is stored in the next storage slot.</li><li>Structs and array data always start a new slot and their items are packed tightly according to these rules.</li><li>Items following struct or array data always start a new storage slot.</li></ul></li><li><p>For intance, two variables <strong>uint128</strong> can be stored in the same slot.</p></li><li><strong><em>Note</em></strong>:<ul><li>When using elements are smaller than 32 bytes, your contract’s gas usage may be higher. This is because the EVM operates on 32 bytes at a time. Therefore, if the element is smaller than that, the EVM must use more operations in order to reduce the size of the element from 32 bytes to the desired size.</li><li>However, you also can take advantage of this to speed up processing. If you save many variables in the same slot and you need all of them for processing, you can combine multiple reads or writes into a single operation to save time.</li><li>For example, in a struct, declaring your storage variables in the order of <strong>int128</strong>, <strong>int128</strong>, <strong>int256</strong> is better than the order of <strong>int128</strong>, <strong>int256</strong>, <strong>int128</strong>. Because the former will only take up two slots of storage whereas the latter will take up three. Furthermore, all elements in a struct often are processed together, the former will only take up two operations to read or write whereas the latter will take three.</li></ul></li><li><p>The value corresponding to a array is located at <strong>keccak256(p)</strong>.</p></li><li>For intance, the location of <strong>x[i][j]</strong>, where the type of <strong>x</strong> is <strong>uint24[][]</strong>, is computed as follows (assuming <strong>x</strong> itself is stored at slot <strong>p</strong>):<ul><li>The slot is <strong>keccak256(keccak256(p) + i) + floor(j / floor(256 / 24))</strong></li><li><strong>x</strong> -&gt; <strong>p</strong></li><li><strong>x[0]</strong> -&gt; <strong>keccak256(p)</strong></li><li><strong>x[i]</strong> -&gt; <strong>keccak256(p) + i</strong></li><li><strong>x[i][0]</strong> -&gt; <strong>keccak256(keccak256(p) + i</strong>)</li><li><strong>x[i][j]</strong> -&gt; <strong>keccak256(keccak256(p) + i) + floor(j / floor(256 / 24))</strong></li></ul></li><li>The value corresponding to a mapping key k is located at <strong>keccak256(h(k) . p)</strong> where <strong>.</strong> is concatenation and h is a function that is applied to the key depending on its type:<ul><li>for value types, h pads the value to 32 bytes in the same way as when storing the value in memory.</li><li>for strings and byte arrays, h(k) is just the unpadded data.</li></ul></li><li><p>For intance,</p><div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">mapping</span><span class="p">(</span><span class="kt">uint</span> <span class="o">=&gt;</span> <span class="k">mapping</span><span class="p">(</span><span class="kt">uint</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">))</span> <span class="n">data</span><span class="p">;</span>
</code></pre></div></div></li><li>The location of data[i][j] (assuming the position of the mapping itself is <strong>p</strong>) is: <strong>keccak256(uint256(j) . keccak256(uint256(i) . p))</strong>:<ul><li><strong>data[i]</strong> -&gt; <strong>keccak256(uint256(i) * p)</strong></li><li><strong>data[i][j]</strong> -&gt; <strong>keccak256(uint256(j) * keccak256(uint256(i) * p))</strong></li></ul></li></ul><h3 id="2-layout-of-state-variables-in-memory">2. Layout of state variables in memory</h3><ul><li>Elements in memory arrays in Solidity always occupy multiples of 32 bytes.</li><li>Solidity reserves four 32-byte slots, with specific byte ranges (inclusive of endpoints) being used as follows:<ul><li>0x00 - 0x3f (64 bytes): scratch space for hashing methods</li><li>0x40 - 0x5f (32 bytes): currently allocated memory size (free memory pointer)</li><li>0x60 - 0x7f (32 bytes): zero slot</li></ul></li></ul><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>Document Information</h3><ul><li>Author of this article:<a href="https://tuhalang.github.io" target="_blank">Tuhalang</a></li><li>Link to this article:<a href="https://tuhalang.github.io/2022/03/28/Layout-Of-State-Variables-In-Storage/" target="_blank">https://tuhalang.github.io/2022/03/28/Layout-Of-State-Variables-In-Storage/</a></li><li>Copyright statement: free reprint - non-commercial - non-derivative - keep attribution（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">Creative Commons 3.0 License</a>）</li></ul></div></article><div class="share"><div class="share-component" data-disabled='qq,weibo,wechat,douban,qzone'></div></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2022/03/28/Layout-Of-State-Variables-In-Storage/', clientID: 'ee780ad580c724383fc9', clientSecret: 'b27916ae861218d97f817647e98288467e8f1ed0', repo: 'blog-comments', owner: 'tuhalang', admin: ['tuhalang'], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@built/assets/search_data.json?v=1648482569', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/js/jquery.toc.js"></script> <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-7093222719567591" data-ad-slot="2908164598"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></div></div></section><footer class="container"> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7093222719567591" data-ad-slot="5263168187" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2022 <span title="Tuhalang">Tuhalang</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/tuhalang/tuhalang.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://tuhalang.github.io/" title="Home" target="">Home</a></li><li> <a href="https://tuhalang.github.io/categories/" title="Categories" target="">Categories</a></li><li> <a href="https://tuhalang.github.io/archives/" title="Archives" target="">Archives</a></li><li> <a href="https://tuhalang.github.io/wiki/" title="Wiki" target="">Wiki</a></li><li> <a href="https://tuhalang.github.io/about/" title="About" target="">About</a></li><li><a href="https://tuhalang.github.io/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/vendor/share.js/dist/js/share.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/tuhalang/tuhalang.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
